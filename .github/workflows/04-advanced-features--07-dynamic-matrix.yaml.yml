---
name: 04-07 Dynamic Matrix
on:
  workflow_dispatch:
    inputs:
      length:
        description: "Number of foo/bar pairs to generate"
        required: true
        default: "2"

jobs:
  generate-matrix:
    runs-on: ubuntu-24.04
    outputs:
      include: ${{ steps.gen.outputs.include }}
    steps:
      - name: Generate paired list (foo = random, bar = random)
        id: gen
        env:
          LENGTH: ${{ github.event.inputs.length }}
        run: |
          set -euo pipefail

          n="${LENGTH:-2}"

          include_json=$(
            {
              for ((i=1; i<=n; i++)); do
                foo_val=$((RANDOM % 100))
                bar_val=$((RANDOM % 100))
                jq -n -c \
                  --argjson foo "$foo_val" \
                  --argjson bar "$bar_val" \
                  '{foo:$foo, bar:$bar}'
              done
            } | jq -s -c .
          )

          echo "include=$include_json" >> "$GITHUB_OUTPUT"

  execute:
    needs: generate-matrix
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.generate-matrix.outputs.include) }}
    steps:
      - name: Use matrix values (paired randoms)
        run: echo "Matrix - foo=${{ matrix.foo }}, bar=${{ matrix.bar }}"